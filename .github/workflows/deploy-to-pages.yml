name: Deploy to GitHub Pages

on:
    workflow_run:
        workflows: [ Publish to GitHub Packages ]
        types:
            - completed

run-name: ${{ github.event.workflow_run.head_branch }}

env:
    REGISTRY: ghcr.io
    OWNER: ${{ github.actor }}
    REPOSITORY: ${{ github.event.workflow_run.head_repository.name }}

jobs:
    pull-and-run-container:
        runs-on: ubuntu-latest

        permissions:
            id-token: write

        steps:
            -   name: Checkout repository
                uses: actions/checkout@v4

            -   name: Stop old container
                run: docker stop ${{ env.REPOSITORY }} || true

            -   name: Remove old container
                run: docker container prune

            -   name: Login to GitHub Packages
                uses: docker/login-action@65b78e6e13532edd9afa3aa52ac7964289d1a9c1
                with:
                    registry: ${{ env.REGISTRY }}
                    username: ${{ env.OWNER }}
                    password: ${{ secrets.GITHUB_TOKEN }}

            -   name: Pull Docker image
                run: docker pull ${{ env.REGISTRY }}/${{ env.OWNER }}/${{ env.REPOSITORY }}/${{ env.REPOSITORY }}:latest

            -   name: Run Docker container
                run: docker run --name ${{ env.REPOSITORY }} -p 3080:3000 -d ${{ env.REGISTRY }}/${{ env.OWNER }}/${{ env.REPOSITORY }}/${{ env.REPOSITORY }}:latest
